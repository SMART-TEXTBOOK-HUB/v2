<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reset Password</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body class="login-body">

    <div class="login-wrapper" id="reset-form-container">
        <h2 class="login-title">Reset Password</h2>

        <!-- This form only works when accessed via Supabase email link -->
        <div id="loading-state" style="text-align: center; padding: 20px;">
            <p style="color: #aaa;">Verifying reset link...</p>
        </div>

        <div id="reset-form" style="display: none;">
            <div class="input-group">
                <input type="password" id="new-password" placeholder="New Password" required>
            </div>

            <div class="input-group">
                <input type="password" id="confirm-password" placeholder="Confirm New Password" required>
            </div>

            <div class="checkbox-group">
                <input type="checkbox" id="show-password">
                <label for="show-password">Show Password</label>
            </div>

            <div class="auth-actions">
                <button type="button" id="btn-reset" class="btn-auth signin" style="width: 100%;">Set New
                    Password</button>
            </div>

            <div id="reset-feedback" class="auth-message"></div>
        </div>

        <div id="error-state" style="display: none; text-align: center; padding: 20px;">
            <p style="color: var(--danger); margin-bottom: 15px;">Invalid or expired reset link.</p>
            <p style="color: #888; font-size: 0.9rem;">Please request a new password reset from the login page.</p>
            <a href="login.html" class="btn-auth signin"
                style="display: inline-block; margin-top: 20px; text-decoration: none;">Back to Login</a>
        </div>

        <div id="success-state" style="display: none; text-align: center; padding: 20px;">
            <i class="fas fa-check-circle" style="font-size: 3rem; color: var(--success); margin-bottom: 15px;"></i>
            <p style="color: var(--success); margin-bottom: 15px;">Password updated successfully!</p>
            <a href="login.html" class="btn-auth signin"
                style="display: inline-block; margin-top: 10px; text-decoration: none;">Sign In</a>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // --- CONFIG ---
        const SUPABASE_URL = 'https://suwbojgdhcpuaqmiqmkg.supabase.co';
        const SUPABASE_ANON_KEY = 'sb_publishable_Cd3s159DP-FKWCWmnHHA8w_hi9_7wh_';

        const { createClient } = window.supabase;
        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
            auth: {
                storage: window.localStorage,
                autoRefreshToken: true,
                persistSession: true,
                detectSessionInUrl: true
            }
        });

        // UI Elements
        const loadingState = document.getElementById('loading-state');
        const resetForm = document.getElementById('reset-form');
        const errorState = document.getElementById('error-state');
        const successState = document.getElementById('success-state');
        const feedbackEl = document.getElementById('reset-feedback');

        // Check for valid reset token/session
        async function init() {
            console.log("[Reset Password] Initializing...");
            console.log("[Reset Password] URL Hash:", window.location.hash);

            // Check if URL contains recovery tokens
            const hash = window.location.hash;
            const hasRecoveryToken = hash.includes('access_token') || hash.includes('type=recovery');

            console.log("[Reset Password] Has recovery token in URL:", hasRecoveryToken);

            if (hasRecoveryToken) {
                // Give Supabase time to process the token
                console.log("[Reset Password] Recovery token found, waiting for Supabase to process...");
            }

            // Listen for auth state changes (PASSWORD_RECOVERY event)
            supabase.auth.onAuthStateChange((event, session) => {
                console.log("[Reset Password] Auth Event:", event, session);

                if (event === 'PASSWORD_RECOVERY') {
                    console.log("[Reset Password] PASSWORD_RECOVERY event received!");
                    loadingState.style.display = 'none';
                    resetForm.style.display = 'block';
                } else if (event === 'SIGNED_IN' && hasRecoveryToken) {
                    // Sometimes Supabase fires SIGNED_IN instead of PASSWORD_RECOVERY
                    console.log("[Reset Password] SIGNED_IN with recovery token - showing form");
                    loadingState.style.display = 'none';
                    resetForm.style.display = 'block';
                }
            });

            // Also check session immediately
            const { data: { session }, error } = await supabase.auth.getSession();
            console.log("[Reset Password] Initial session:", { session, error });

            // If we have a session and URL has recovery token, show form
            if (session && hasRecoveryToken) {
                console.log("[Reset Password] Session exists with recovery token - showing form");
                loadingState.style.display = 'none';
                resetForm.style.display = 'block';
                return;
            }

            // If no session and no recovery token, show error after a delay
            if (!hasRecoveryToken) {
                setTimeout(() => {
                    if (loadingState.style.display !== 'none') {
                        console.warn("[Reset Password] No valid recovery token found");
                        loadingState.style.display = 'none';
                        errorState.style.display = 'block';
                    }
                }, 2000);
            }
        }

        // Show Password Toggle
        document.getElementById('show-password').addEventListener('change', (e) => {
            const type = e.target.checked ? 'text' : 'password';
            document.getElementById('new-password').type = type;
            document.getElementById('confirm-password').type = type;
        });

        // Reset Password Handler
        document.getElementById('btn-reset').addEventListener('click', async () => {
            const btn = document.getElementById('btn-reset');
            const newPass = document.getElementById('new-password').value;
            const confirmPass = document.getElementById('confirm-password').value;

            if (!newPass || !confirmPass) {
                feedbackEl.textContent = "Please fill in both fields.";
                feedbackEl.className = "auth-message error";
                return;
            }

            if (newPass !== confirmPass) {
                feedbackEl.textContent = "Passwords do not match.";
                feedbackEl.className = "auth-message error";
                return;
            }

            if (newPass.length < 6) {
                feedbackEl.textContent = "Password must be at least 6 characters.";
                feedbackEl.className = "auth-message error";
                return;
            }

            btn.textContent = "Updating...";
            btn.disabled = true;
            feedbackEl.textContent = "";

            try {
                console.log("[Reset Password] Updating password...");
                const { error } = await supabase.auth.updateUser({ password: newPass });

                if (error) {
                    throw error;
                }

                console.log("[Reset Password] Success!");
                resetForm.style.display = 'none';
                successState.style.display = 'block';

            } catch (e) {
                console.error("[Reset Password] Error:", e);
                feedbackEl.textContent = "Error: " + (e.message || e);
                feedbackEl.className = "auth-message error";
                btn.textContent = "Set New Password";
                btn.disabled = false;
            }
        });

        // Initialize
        init();
    </script>
</body>

</html>