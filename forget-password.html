<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reset Password</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body class="login-body">

    <div class="login-wrapper" id="reset-form-container">
        <h2 class="login-title">Reset Password</h2>

        <div id="loading-state" style="text-align: center; padding: 20px;">
            <p style="color: #aaa;">Verifying reset link...</p>
        </div>

        <div id="reset-form" style="display: none;">
            <div style="text-align:center; margin-bottom:15px; color:#aaa;" id="email-label"></div>
            <div class="input-group">
                <input type="password" id="new-password" placeholder="New Password" required>
            </div>

            <div class="input-group">
                <input type="password" id="confirm-password" placeholder="Confirm New Password" required>
            </div>

            <div class="checkbox-group">
                <input type="checkbox" id="show-password">
                <label for="show-password">Show Password</label>
            </div>

            <div class="auth-actions">
                <button type="button" id="btn-reset" class="btn-auth signin" style="width: 100%;">Set New
                    Password</button>
            </div>

            <div id="reset-feedback" class="auth-message"></div>
        </div>

        <div id="error-state" style="display: none; text-align: center; padding: 20px;">
            <p style="color: var(--danger); margin-bottom: 15px;">Invalid or expired reset link.</p>
            <p style="color: #888; font-size: 0.9rem;">Please request a new password reset from the login page.</p>
            <a href="login.html" class="btn-auth signin"
                style="display: inline-block; margin-top: 20px; text-decoration: none;">Back to Login</a>
        </div>

        <div id="success-state" style="display: none; text-align: center; padding: 20px;">
            <i class="fas fa-check-circle" style="font-size: 3rem; color: var(--success); margin-bottom: 15px;"></i>
            <p style="color: var(--success); margin-bottom: 15px;">Password updated successfully!</p>
            <a href="login.html" class="btn-auth signin"
                style="display: inline-block; margin-top: 10px; text-decoration: none;">Sign In</a>
        </div>
    </div>

    <!-- Use Type Module to access window.Auth logic from script.js -->
    <script type="module" src="script.js"></script>

    <script type="module">
        // --- LOGIC ---
        // Wait for script.js to load its global methods
        // Since both are modules, we might need a small delay or event if logic isn't immediate, 
        // but window.Auth is set in DOMContentLoaded of script.js usually, or top level.
        // Let's rely on window.Auth being available after module load.

        document.addEventListener('DOMContentLoaded', async () => {
            // UI Elements
            const loadingState = document.getElementById('loading-state');
            const resetForm = document.getElementById('reset-form');
            const errorState = document.getElementById('error-state');
            const successState = document.getElementById('success-state');
            const feedbackEl = document.getElementById('reset-feedback');
            const emailLabel = document.getElementById('email-label');

            // Get oobCode from URL
            const urlParams = new URLSearchParams(window.location.search);
            const oobCode = urlParams.get('oobCode');

            console.log("[Reset] oobCode found:", oobCode);

            if (!oobCode) {
                loadingState.style.display = 'none';
                errorState.style.display = 'block';
                return;
            }

            // Verify Code
            // Need to wait for window.Auth to be available if script.js loads async

            // Simple check loop
            let attempts = 0;
            while (!window.Auth && attempts < 20) {
                await new Promise(r => setTimeout(r, 100));
                attempts++;
            }

            if (!window.Auth) {
                loadingState.style.display = 'none';
                feedbackEl.textContent = "Error loading auth system.";
                return;
            }

            const verifyRes = await window.Auth.verifyResetCode(oobCode);
            if (verifyRes.error) {
                console.error("Verify Error:", verifyRes.error);
                loadingState.style.display = 'none';
                errorState.style.display = 'block';
            } else {
                console.log("Verified Email:", verifyRes.email);
                loadingState.style.display = 'none';
                resetForm.style.display = 'block';
                if (verifyRes.email) emailLabel.textContent = `Resetting password for: ${verifyRes.email}`;
            }

            // Logic for Reset Button
            document.getElementById('btn-reset').addEventListener('click', async () => {
                const newPass = document.getElementById('new-password').value;
                const confirmPass = document.getElementById('confirm-password').value;

                if (!newPass || newPass !== confirmPass) {
                    feedbackEl.textContent = "Passwords do not match or empty.";
                    feedbackEl.className = "auth-message error";
                    return;
                }

                if (newPass.length < 6) {
                    feedbackEl.textContent = "Password too short (min 6 chars).";
                    feedbackEl.className = "auth-message error";
                    return;
                }

                const btn = document.getElementById('btn-reset');
                btn.textContent = "Updating...";
                btn.disabled = true;

                const res = await window.Auth.confirmReset(oobCode, newPass);

                if (res.error) {
                    feedbackEl.textContent = res.error;
                    feedbackEl.className = "auth-message error";
                    btn.textContent = "Set New Password";
                    btn.disabled = false;
                } else {
                    resetForm.style.display = 'none';
                    successState.style.display = 'block';
                }
            });

            // Toggle Password
            document.getElementById('show-password').addEventListener('change', (e) => {
                const type = e.target.checked ? 'text' : 'password';
                document.getElementById('new-password').type = type;
                document.getElementById('confirm-password').type = type;
            });
        });
    </script>
</body>

</html>